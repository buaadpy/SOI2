/**
 * Created by 杜鹏宇 on 2015/7/22
 * Modified by
 */

//地图管理
MapControl = function () {
    this.gamescene = null;//连接游戏场景
    this.treeX = [217.77346024755388,
        147.16343181207776,
        51.15102395648137,
        -5.1206430536694825,
        -186.9246948044747,
        187.84895176067948,
        -129.42187960725278,
        169.21484149061143,
        -198.17879875190556,
        -96.84299526270479,
        121.13858973607421,
        40.44477712595835,
        65.26569941779599,
        150.68000627215952,
        87.27278433507308,
        -207.5619275914505,
        193.9542199135758,
        -147.11564343888313,
        -27.053431933745742,
        27.202959428541362,
        -110.02131029963493,
        -39.99981719534844,
        199.23014369560406,
        -162.09122752770782,
        -147.98509395914152,
        -118.52013599127531,
        -158.91262345248833,
        -148.6181881162338,
        -101.26067743403837,
        -177.4892613175325,
        98.57431958662346,
        189.50710060307756,
        -4.85223785508424,
        20.86500901496038,
        -20.349366904702038,
        50.85071828216314,
        14.287386985961348,
        223.18163925083354,
        218.51509942207485,
        -136.2653608317487,
        -104.50984277995303,
        49.46174042997882,
        83.9130658772774,
        164.12167819216847,
        -224.94021146558225,
        167.79545817989856,
        -124.81998468283564,
        -114.12483433960006,
        -201.39212391804904,
        34.66038729529828,
        78.43969085952267,
        6.439344619866461,
        -97.99874613527209,
        134.43301561055705,
        167.11283986223862,
        73.55880313552916,
        17.39143906161189,
        -8.576126222033054,
        125.34880366874859,
        -114.15471959626302,
        41.70388032216579,
        45.01431748503819,
        -57.346616755239666,
        129.79980799136683,
        6.325187813490629,
        81.4566601999104,
        -75.89738597162068,
        133.909986843355,
        53.629972343333066,
        189.3155517987907,
        -68.68840850656852,
        -130.03691883059219,
        186.57289553666487,
        191.75272781867534,
        11.987126630265266,
        137.65342589467764,
        -135.18290121573955,
        55.81113811349496,
        138.55066378600895,
        -175.61152714770287,
        -74.86832630820572,
        215.9721953328699,
        123.48695257678628,
        -35.55305746849626,
        -81.54540286632255,
        -61.167246638797224,
        -155.2448465838097,
        222.20092399511486,
        20.36180931609124,
        83.81206729682162,
        -86.71259272377938,
        -160.3144804132171,
        171.53547710040584,
        39.725243125576526,
        49.238336621783674,
        61.60134928068146,
        -71.33437521988526,
        -0.6425986066460609,
        10.45051779365167,
        138.23034757515416,
        9.182848397176713,
        -146.70637249946594,
        -199.09245060989633,
        136.22181464452296,
        182.85497979959473,
        -171.84345598798245,
        86.36305175023153,
        68.42658634996042,
        -173.30269231460989,
        35.08082911139354,
        207.71496532252058,
        24.017750727944076,
        76.09342056093737,
        -64.10623368574306,
        -0.020985770970582962,
        -85.87907186010852,
        -70.78110884176567,
        205.6220234837383,
        220.17970788292587,
        -102.95545110711828,
        -157.19705626834184,
        -48.43264545779675,
        -33.87373531004414,
        91.4725181646645,
        2.5885830516926944,
        -3.8810310303233564,
        70.78700278652832,
        46.64864611113444,
        -4.989448352716863,
        -20.14998154481873,
        150.74086150852963,
        116.63802741095424,
        197.74564818944782,
        95.62057567527518,
        -39.09510977100581,
        -35.37551712943241,
        -178.7401201785542,
        168.40312719577923,
        -2.8400534531101584,
        79.14998035412282,
        -2.4705795804038644,
        73.4612382017076,
        68.8352997880429,
        112.23035207949579,
        183.1522842287086,
        -74.63967584772035,
        129.09142789430916,
        98.83227600948885,
        -186.24382180860266,
        -149.68780560884625];//树的x坐标
    this.treeZ = [-77.36262583639473,
        179.95032838080078,
        98.65575312869623,
        193.1755300029181,
        -134.28675506729633,
        -33.03926666267216,
        -207.2482941672206,
        149.56122807925567,
        -145.77531362883747,
        89.07815397251397,
        87.91229127673432,
        -205.62809271505103,
        131.2218987615779,
        -29.580194782465696,
        65.8576900837943,
        192.20304389018565,
        97.77058297768235,
        -189.60456065833569,
        -125.57708836393431,
        -90.30013927258551,
        37.59630457498133,
        -171.8168414547108,
        80.84774814778939,
        -186.1325599020347,
        -20.56486668298021,
        54.65073297964409,
        197.85065761534497,
        -54.58411581348628,
        -62.064641586039215,
        66.01420452352613,
        200.87166305165738,
        -30.260390206240118,
        -183.05792212486267,
        -196.65050979238003,
        -80.41164505993947,
        -64.41006688401103,
        19.122264243196696,
        146.07915604719892,
        -101.22013374930248,
        -151.6308547114022,
        119.55518305767328,
        48.17458384204656,
        -5.86582274409011,
        49.889929639175534,
        31.36187894269824,
        48.91259438591078,
        169.38440456287935,
        -136.2619794672355,
        55.420566990505904,
        37.30810582637787,
        -148.84076201124117,
        16.501487349160016,
        197.2062712535262,
        103.15259252674878,
        183.68684146553278,
        114.00229971623048,
        202.41527758771554,
        127.76480469619855,
        59.28605608642101,
        -121.91594042815268,
        -116.45413495134562,
        88.73563221422955,
        -223.06294249137864,
        -90.68009513430297,
        1.4497430878691375,
        119.33270241133869,
        -28.989392251241952,
        85.63604172086343,
        140.22818708326668,
        -177.44624738115817,
        180.77562953112647,
        -218.9936824142933,
        72.89666788419709,
        -120.4285103129223,
        94.42389062605798,
        -48.95571812521666,
        76.64006020640954,
        40.50893158419058,
        -71.82011405238882,
        31.802440260071307,
        -49.811869813129306,
        213.49140910897404,
        63.46503506647423,
        185.84395033540204,
        46.93549589719623,
        13.236770848743618,
        126.78929344983771,
        45.79730867408216,
        179.55233372049406,
        111.26344338990748,
        18.806166958529502,
        -121.0907818749547,
        80.66668342798948,
        -63.238403701689094,
        128.1937564490363,
        97.86844976479188,
        -198.352881136816,
        183.68881760397926,
        215.4072462581098,
        -7.024101598653942,
        187.9065734683536,
        103.16067320527509,
        -113.46965575357899,
        -165.09123881114647,
        -34.28867136826739,
        81.53028840897605,
        -162.24099547835067,
        192.7707838243805,
        207.39892786368728,
        -212.73049658630043,
        -80.32822699751705,
        56.25278048682958,
        12.911887757945806,
        124.87920377170667,
        184.77939027361572,
        -32.31117777759209,
        35.18786769127473,
        -80.65274086548015,
        212.8426569281146,
        -166.4930433849804,
        -95.17726498888806,
        174.34664693428203,
        -124.05629638815299,
        -6.147849059198052,
        7.8345152316614985,
        53.68309097830206,
        -215.68248176481575,
        123.34662411594763,
        23.745978414081037,
        163.51970551768318,
        -9.224926913157105,
        130.59803140349686,
        100.34171061124653,
        27.84627793589607,
        -61.94540828000754,
        -166.09000019961968,
        -218.1839833385311,
        56.44391532987356,
        -57.54089334513992,
        -121.57811085926369,
        77.79176995391026,
        28.686652157921344,
        -64.88761774962768,
        87.90047185029835,
        -97.41836052853614,
        -203.27663936186582,
        -47.3231733776629,
        118.81139203906059,
        100.27612693374977,
        8.61391247017309];//树的z坐标
}

//创造地图
MapControl.prototype.createMap = function () {
    //加载天空盒
    var skybox = BABYLON.Mesh.CreateBox('skyBox', 2000.0, this.gamescene);
    var skyboxMaterial = new BABYLON.StandardMaterial('skyBox', this.gamescene);
    skyboxMaterial.backFaceCulling = false;
    skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture('../asset/image/skybox/skybox', this.gamescene);
    skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
    skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
    skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
    skybox.material = skyboxMaterial;
    //加载岛屿
    var groundMaterial = new BABYLON.StandardMaterial('ground', this.gamescene);
    groundMaterial.diffuseTexture = new BABYLON.Texture('../asset/image/map/island.jpg', this.gamescene);
    var ground = BABYLON.Mesh.CreateGroundFromHeightMap('ground', '../asset/image/map/island_height.jpg', 1200, 1200, 300, 0, 35, this.gamescene, false);
    ground.material = groundMaterial;
    ground.checkCollisions = true;
    //加载水
    var waterMesh = BABYLON.Mesh.CreateGround('waterMesh', 2000, 2000, 1, this.gamescene, false);
    var water = new BABYLON.WaterMaterial('water', this.gamescene);
    water.bumpTexture = new BABYLON.Texture('../asset/image/map/waterbump.png', this.gamescene);
    water.windForce = 0.7;
    water.waveHeight = 0.5;
    water.windDirection = new BABYLON.Vector2(1, 1);
    water.waterColor = new BABYLON.Color3(0.0, 0.3, 0.6);
    water.colorBlendFactor = 0.3;
    water.bumpHeight = 0.1;
    water.waveLength = 0.2;
    water.addToRenderList(skybox);
    waterMesh.material = water;
    waterMesh.position.y = 0;
    //加载树
    var _this = this;
    ground.onReady = function () {
        // Trees
        BABYLON.SceneLoader.ImportMesh("", "../asset/babylon/", "tree.babylon", _this.gamescene, function (newMeshes) {
            newMeshes[0].material.opacityTexture = null;
            newMeshes[0].material.backFaceCulling = false;
            newMeshes[0].isVisible = false;
            newMeshes[0].position.y = ground.getHeightAtCoordinates(0, 0); // Getting height from ground object
            var count = 150;
            for (var index = 0; index < count; index++) {
                var newInstance = newMeshes[0].createInstance("i" + index);
                var x = _this.treeX[index];
                var z = _this.treeZ[index];
                var y = ground.getHeightAtCoordinates(x, z); // Getting height from ground object
                newInstance.position = new BABYLON.Vector3(x, y, z);
                newInstance.rotate(BABYLON.Axis.Y, index / count * Math.PI * 2, BABYLON.Space.WORLD);
                var scale = 6;
                newInstance.scaling.addInPlace(new BABYLON.Vector3(scale, scale, scale));
            }
            game.engine.hideLoadingUI();
        });
    }
}